# Backend Visual Report Generation Specification

## Endpoint: `POST /api/report/{scanId}/visual`

### Purpose
Generate a professional PDF report with visual markup showing issue locations on 2D drawings converted from any supported file format.

---

## Request

### URL Parameters
- `scanId` (string, required): UUID of the scan record

### Request Body
```json
{
  "fileName": "Building-Floor1.ifc",
  "filePath": "user-uuid/file-uuid.ifc",
  "findings": [
    {
      "id": "finding-uuid",
      "title": "Wall thickness non-compliant",
      "description": "Wall element IfcWall_123 has thickness 100mm, minimum required is 150mm",
      "severity": "high",
      "discipline": "architecture",
      "element_guid": "IfcWall_123",
      "element_name": "Exterior Wall A",
      "location": {
        "x": 1250.5,
        "y": 3400.2,
        "z": 0,
        "floor": "Level 1"
      }
    }
  ],
  "timestamp": "2025-10-08T10:30:00Z"
}
```

---

## Processing Requirements

### 1. Fetch Original File
- Download file from Supabase Storage using `filePath`
- Support formats: IFC, RVT, DWG, DXF, PDF, XLSX, CSV, DOCX

### 2. Convert to 2D Visual Representation

#### For BIM/CAD Files (IFC, RVT, DWG, DXF)
- **Convert to 2D floor plan view** (top-down projection)
- Use conversion tools:
  - `IfcConvert` for IFC files
  - `xeokit-sdk` for web-based IFC rendering
  - `AutoCAD` or `LibreCAD` for DWG/DXF
  - `RvtConverter` or Revit API for RVT files
- Generate one 2D drawing per floor/level
- Export as high-resolution PNG/SVG (300 DPI minimum)

#### For PDF Drawings
- Parse existing PDF pages
- Extract drawing pages (skip text-only pages)
- Prepare for annotation overlay

#### For Excel/CSV Schedules
- Render as formatted tables
- Highlight rows containing issues
- Style with professional formatting

#### For Word/PDF Specifications
- Extract text content
- Identify sections with issues
- Prepare for text annotation

### 3. Add Visual Markup

#### For 2D Drawings (BIM/CAD/PDF)
- **Red circles** around issue elements (3px stroke, 50px radius)
- **Issue number labels** (white text on red background)
- **Arrow callouts** pointing to exact location
- **Bounding boxes** if element coordinates available
- Use `element_guid` to locate elements in model
- Use `location.x`, `location.y`, `location.z` for positioning

#### For Schedules/Tables
- **Yellow highlight** on affected rows
- **Red border** around problematic cells
- **Issue number** in margin

#### For Specifications
- **Yellow highlight** on relevant text sections
- **Sidebar annotations** with issue details
- **Page references** linking to findings list

### 4. Generate Professional PDF

#### Cover Page
- DesignQA logo and branding
- Project name: "Quality Assurance Report"
- File name: `{fileName}`
- Scan date: `{timestamp}`
- Total issues count
- Generated by: DesignQA Platform

#### Summary Page
- **Total Issues**: 12
- **By Severity**:
  - Critical: 2
  - High: 5
  - Medium: 3
  - Low: 2
- **By Discipline**:
  - Architecture: 7
  - Structural: 3
  - MEP: 2
- **File Type**: IFC Model
- **Scan Timestamp**: Oct 8, 2025 10:30 AM

#### Detailed Findings List
Table format with columns:
- Issue #
- Element ID
- Title
- Severity
- Discipline
- Location
- Description

#### Visual Evidence Pages
- One page per floor/level/drawing
- 2D drawing with markup annotations
- Legend showing issue severity colors
- Scale bar and orientation indicator
- Page numbers and file references

---

## Response

### Success (200 OK)
- **Content-Type**: `application/pdf`
- **Content-Disposition**: `attachment; filename="visual-report-{scanId}.pdf"`
- **Body**: PDF file binary

### Error Responses

#### 404 Not Found
```json
{
  "error": "Scan not found",
  "scanId": "{scanId}"
}
```

#### 400 Bad Request
```json
{
  "error": "File conversion failed",
  "message": "Unable to convert IFC file to 2D drawing",
  "fileType": "ifc"
}
```

#### 500 Internal Server Error
```json
{
  "error": "Report generation failed",
  "message": "Error details here"
}
```

---

## Implementation Libraries

### IFC Conversion
- **IfcConvert** (IfcOpenShell): Command-line IFC converter
- **xeokit-sdk**: Web-based IFC viewer with snapshot export
- **web-ifc**: Fast IFC parsing in Node.js

### PDF Generation
- **jsPDF** (Node.js): PDF generation library
- **PDFKit**: Node.js PDF generation
- **Puppeteer**: HTML-to-PDF with full rendering

### CAD Conversion
- **AutoCAD ODA File Converter**: DWG/DXF to PDF
- **LibreCAD**: Open-source CAD converter
- **dxf-parser**: Node.js DXF parsing

### Image Processing
- **Sharp**: High-performance image manipulation
- **Canvas** (node-canvas): Drawing markup on images
- **ImageMagick**: Image conversion and annotation

---

## Example Workflow

1. **Receive Request**: `POST /api/report/abc-123/visual`
2. **Fetch Scan**: Query database for scan `abc-123`
3. **Download File**: Get `Building.ifc` from Supabase Storage
4. **Convert IFC**:
   ```bash
   IfcConvert -y Building.ifc Building-Level1.png --plan --bounds=auto
   ```
5. **Load Findings**: Parse findings JSON
6. **Add Markup**:
   ```javascript
   const canvas = createCanvas(width, height);
   const ctx = canvas.getContext('2d');
   ctx.drawImage(floorPlan, 0, 0);

   findings.forEach((finding, index) => {
     ctx.strokeStyle = '#EF4444';
     ctx.lineWidth = 3;
     ctx.beginPath();
     ctx.arc(finding.location.x, finding.location.y, 50, 0, Math.PI * 2);
     ctx.stroke();

     ctx.fillStyle = '#EF4444';
     ctx.fillRect(finding.location.x - 20, finding.location.y - 60, 40, 25);
     ctx.fillStyle = '#FFFFFF';
     ctx.font = 'bold 16px Arial';
     ctx.fillText(index + 1, finding.location.x - 8, finding.location.y - 42);
   });
   ```
7. **Generate PDF**:
   ```javascript
   const pdf = new jsPDF('landscape');
   pdf.addImage(markedUpDrawing, 'PNG', 10, 10, 277, 190);
   pdf.save('visual-report.pdf');
   ```
8. **Return PDF**: Send as file download

---

## Frontend Integration

The frontend is already configured to call this endpoint:

```typescript
// src/services/api.ts - reports.downloadPDF()
const response = await fetch(`/api/report/${scanId}/visual`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    fileName: scan.file_name,
    filePath: scan.file_path,
    findings: scan.findings,
    timestamp: scan.timestamp,
  }),
});

const blob = await response.blob();
// Downloads as: Building-visual-markup.pdf
```

---

## Testing Checklist

- [ ] IFC file converts to 2D floor plan
- [ ] Markup circles appear at correct element locations
- [ ] PDF includes cover page with branding
- [ ] Summary page shows correct statistics
- [ ] Findings table is complete and readable
- [ ] Visual evidence pages show marked-up drawings
- [ ] File downloads with correct filename
- [ ] Error handling for unsupported file types
- [ ] Performance: generates PDF in < 30 seconds
- [ ] PDF is professional quality (300 DPI images)

---

## Notes

- **Location coordinates**: If findings don't include `location.x/y/z`, use element GUID to find coordinates from IFC model
- **Multi-story buildings**: Generate separate pages for each level/floor
- **Large files**: Implement pagination or tile-based rendering for large drawings
- **Caching**: Consider caching converted 2D drawings for faster subsequent report generation
- **Queue system**: For heavy processing, use job queue (Bull/BullMQ) to handle async generation
